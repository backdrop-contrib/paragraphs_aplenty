<?php

/**
 * @file
 * USWDS Paragraphs module code.
 */

/**
 * Implements hook_theme().
 */
function uswds_paragraphs_theme($existing, $type, $theme, $path) {
  return [
    'paragraph__uswds_hero' => [
      'base hook' => 'paragraph',
    ],
    'paragraph__uswds_hero_callout' => [
      'base hook' => 'paragraph',
    ],
    'paragraph__uswds_graphic_list' => [
      'base hook' => 'paragraph',
    ],
    'paragraph__uswds_media_block' => [
      'base hook' => 'paragraph',
    ],
    'paragraph__uswds_one_and_two' => [
      'base hook' => 'paragraph',
    ],
    'paragraph__uswds_two_and_one' => [
      'base hook' => 'paragraph',
    ],
  ];
}

/**
 * Implements hook_preprocess_paragraph().
 */
function uswds_paragraphs_preprocess_paragraph(&$variables) {
  $paragraph_type = $variables['paragraph']->bundle();

  // We need to set the media_block class here, because we side-step the field
  // template in paragraph--uswds-media-block.html.twig.
  if ('uswds_media_block' == $paragraph_type) {
    $variables['content']['field_uswds_image'][0]['#item_attributes']['class'][] = 'usa-media_block-img';
  }

  if ('uswds_graphic_list' == $paragraph_type) {

    // Here we split the media blocks into pairs.
    $pairs = [];
    $pair = [];
    $media_block_keys = \Drupal\Core\Render\Element::children($variables['content']['field_uswds_media_block'], TRUE);
    foreach ($media_block_keys as $key) {
      if (count($pair) < 2) {
        $pair[] = $variables['content']['field_uswds_media_block'][$key];
      }
      if (count($pair) == 2) {
        $pairs[] = $pair;
        $pair = [];
      }
    }
    // Catch any stragglers.
    if (!empty($pair)) {
      $pairs[] = $pair;
    }
    $variables['graphic_list_rows'] = $pairs;
  }
}

/**
 * Implements hook_preprocess_field().
 */
function uswds_paragraphs_preprocess_field(&$variables) {
  if (strpos($variables['field_name'], 'field_uswds_') !== 0) {
    return;
  }

  $paragraph_type = $variables['element']['#bundle'];
  $field_type = $variables['field_type'];
  $field_name = $variables['field_name'];

  if ('link' == $field_type) {

    // Choose appropriate classes for paragraph type and field.
    $classes = [
      // Paragraph type.
      'uswds_hero_callout' => [
        // Field name.
        'field_uswds_button' => [
          'usa-button',
          'usa-button-big',
          'usa-button-secondary',
        ],
        'field_uswds_link' => [
          'usa-hero-link',
        ],
      ],
    ];

    if (!empty($classes[$paragraph_type][$field_name])) {
      $class = ['class' => $classes[$paragraph_type][$field_name]];
      $variables['items'][0]['content']['#url']->setOption('attributes', $class);
    }
  }
}
